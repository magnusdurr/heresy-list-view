<div class="mb-4">
    <h2 class="mb-3">Special Rules</h2>
    <div class="row align-items-center">
        <div class="col-12 col-lg-9 mb-2">
            <div class="d-flex flex-wrap align-items-center">
                <label class="form-label me-2 mb-1">Filter by type:</label>
                <div class="btn-group btn-group-sm flex-wrap" role="group" aria-label="Rule Filter" id="tag-filters">
                    <button type="button" class="btn btn-outline-secondary active" data-filter="all">All</button>
                    <!-- Dynamic tag buttons will be inserted here -->
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-3 mb-2">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="excludeCore" checked>
                <label class="form-check-label" for="excludeCore">Exclude Core</label>
            </div>
        </div>
    </div>
</div>

<p class="lead">
    This page contains all special rules available in EA-Heresy.
</p>

<div id="rules-container">
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p>Loading special rules...</p>
    </div>
</div>

<style>
/* Minimal custom styling - mostly using Bootstrap defaults */
.btn-group.flex-wrap {
    flex-wrap: wrap;
}

.btn-group.flex-wrap .btn {
    margin-right: 0.25rem;
    margin-bottom: 0.25rem;
}

/* Small gap utility for older Bootstrap versions */
.gap-1 > * + * {
    margin-left: 0.25rem;
}
</style>

<script>
$(document).ready(function() {
    var allRules = [];
    
    // Load special rules data
    $.get('lists/specialRules.json')
        .done(function(data) {
            allRules = data.rules;
            setupDynamicFilters(allRules);
            displaySpecialRules(allRules);
            setupFiltering(allRules);
        })
        .fail(function() {
            $('#rules-container').html('<div class="alert alert-danger">Failed to load special rules data.</div>');
        });
    
    // Map rule tags to Bootstrap badge classes
    function getBadgeClass(tag) {
        const badgeMap = {
            'unit': 'primary',
            'weapon': 'warning',
            'army': 'secondary', 
            'core': 'light',
            'formation': 'success',
            'legion': 'info',
            'loyalist': 'primary',
            'traitor': 'danger',
            'alpha': 'dark',
            'titan': 'secondary',
            'offboard': 'secondary'
        };
        return badgeMap[tag] || 'secondary';
    }
    
    function prepareRulesForTemplate(rules, totalRules) {
        // Sort rules alphabetically by title (case-insensitive)
        const sortedRules = rules.slice().sort(function(a, b) {
            return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
        });
        
        return {
            rulesCount: 'Showing ' + sortedRules.length + ' of ' + totalRules + ' rules',
            rules: sortedRules.map(function(rule) {
                // Generate badges based on tags
                var badges = [];
                if (rule.tags && Array.isArray(rule.tags)) {
                    rule.tags.forEach(function(tag) {
                        badges.push({
                            class: getBadgeClass(tag),
                            text: tag.charAt(0).toUpperCase() + tag.slice(1)
                        });
                    });
                }
                
                return {
                    title: rule.title,
                    description: rule.description,
                    badges: badges,
                    tags: rule.tags || []
                };
            })
        };
    }
    
    function displaySpecialRules(rules, filteredRules = null) {
        const rulesToShow = filteredRules || rules;
        
        if (rulesToShow.length === 0) {
            $('#rules-container').html('<div class="alert alert-info">No rules match the current filter criteria.</div>');
            return;
        }
        
        // Check if template is loaded
        if (!eaTemplating.templates['special-rules-list']) {
            $('#rules-container').html('<div class="alert alert-warning">Template loading... Please try again in a moment.</div>');
            return;
        }
        
        const templateData = prepareRulesForTemplate(rulesToShow, allRules.length);
        const html = eaTemplating.templates['special-rules-list'](templateData);
        $('#rules-container').html(html);
    }
    
    function setupDynamicFilters(rules) {
        // Collect all unique tags (excluding 'core' which is handled specially)
        var allTags = new Set();
        
        rules.forEach(function(rule) {
            if (rule.tags && Array.isArray(rule.tags)) {
                rule.tags.forEach(function(tag) {
                    if (tag !== 'core') {
                        allTags.add(tag);
                    }
                });
            }
        });
        
        // Sort tags alphabetically
        var sortedTags = Array.from(allTags).sort();
        
        // Generate dynamic filter buttons
        var tagFiltersContainer = $('#tag-filters');
        
        sortedTags.forEach(function(tag) {
            var buttonText = tag.charAt(0).toUpperCase() + tag.slice(1);
            var button = $('<button type="button" class="btn btn-outline-secondary" data-filter="' + tag + '">' + buttonText + '</button>');
            tagFiltersContainer.append(button);
        });
    }
    
    function setupFiltering(rules) {
        const excludeCheckbox = $('#excludeCore');
        
        function applyFilters() {
            const activeFilter = $('#tag-filters button.active').data('filter');
            const excludeCore = excludeCheckbox.is(':checked');
            
            let filteredRules = rules;
            
            // Apply core filter (special case)
            if (excludeCore) {
                filteredRules = filteredRules.filter(rule => {
                    // Check tags array for core tag
                    return !(rule.tags && Array.isArray(rule.tags) && rule.tags.includes('core'));
                });
            }
            
            // Apply tag filter
            if (activeFilter && activeFilter !== 'all') {
                filteredRules = filteredRules.filter(rule => {
                    // Check if rule has the selected tag
                    return rule.tags && Array.isArray(rule.tags) && rule.tags.includes(activeFilter);
                });
            }
            
            displaySpecialRules(allRules, filteredRules);
        }
        
        // Dynamic filter button handlers (using event delegation)
        $('#tag-filters').on('click', 'button[data-filter]', function() {
            $('#tag-filters button').removeClass('active');
            $(this).addClass('active');
            applyFilters();
        });
        
        // Checkbox handler
        excludeCheckbox.on('change', function() {
            applyFilters();
        });
        
        // Initial filter application
        applyFilters();
    }
});
</script>
