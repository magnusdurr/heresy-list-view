<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Special Rules</h2>
    <div class="d-flex align-items-center flex-wrap">
        <div class="btn-group mr-3 mb-2" role="group" aria-label="Rule Filter" id="tag-filters">
            <button type="button" class="btn btn-outline-secondary active" data-filter="all">All</button>
            <!-- Dynamic tag buttons will be inserted here -->
        </div>
        <div class="custom-control custom-switch mb-2">
            <input type="checkbox" class="custom-control-input" id="excludeCore" checked>
            <label class="custom-control-label" for="excludeCore">Exclude Core</label>
        </div>
    </div>
</div>

<p class="lead">
    This page contains all special rules available in EA-Heresy.
</p>

<div id="rules-container">
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p>Loading special rules...</p>
    </div>
</div>

<style>
/* Custom styling for the special rules page */
.rule-card {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
    background: #fff;
    transition: all 0.2s ease-in-out;
}

.rule-card:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border-color: #adb5bd;
}

.rule-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 0.75rem 1rem;
    border-radius: 0.375rem 0.375rem 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.rule-title {
    font-weight: 600;
    color: #495057;
    margin: 0;
    font-size: 1.1rem;
}

.rule-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-weight: 500;
}

/* Default styling for all badges */
.rule-badge {
    background-color: #6c757d;
    color: white;
}

/* Specific styling for known tag types */
.rule-badge.unit { background-color: #007bff; color: white; }
.rule-badge.weapon { background-color: #ffc107; color: #212529; }
.rule-badge.army { background-color: #6c757d; color: white; }
.rule-badge.core { background-color: #e9ecef; color: #6c757d; }
.rule-badge.formation { background-color: #28a745; color: white; }

.rule-badges {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
}

/* Dynamic filter buttons layout */
#tag-filters {
    flex-wrap: wrap;
    gap: 0.25rem;
}

#tag-filters .btn {
    margin-bottom: 0.25rem;
}

.rule-content {
    padding: 1rem;
}

.rule-description {
    margin: 0;
    line-height: 1.6;
    color: #495057;
}

.rule-description ul {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}

.rule-description li {
    margin-bottom: 0.25rem;
}

.custom-control-label {
    color: #6c757d;
    font-size: 0.9rem;
}

.btn-outline-secondary.active {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

#rules-count {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}
</style>

<script>
$(document).ready(function() {
    var allRules = [];
    
    // Load special rules data
    $.get('lists/specialRules.json')
        .done(function(data) {
            allRules = data.rules;
            setupDynamicFilters(allRules);
            displaySpecialRules(allRules);
            setupFiltering(allRules);
        })
        .fail(function() {
            $('#rules-container').html('<div class="alert alert-danger">Failed to load special rules data.</div>');
        });
    
    function prepareRulesForTemplate(rules, totalRules) {
        // Sort rules alphabetically by title (case-insensitive)
        const sortedRules = rules.slice().sort(function(a, b) {
            return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
        });
        
        return {
            rulesCount: 'Showing ' + sortedRules.length + ' of ' + totalRules + ' rules',
            rules: sortedRules.map(function(rule) {
                // Generate badges based on tags
                var badges = [];
                if (rule.tags && Array.isArray(rule.tags)) {
                    rule.tags.forEach(function(tag) {
                        badges.push({
                            class: tag,
                            text: tag.charAt(0).toUpperCase() + tag.slice(1)
                        });
                    });
                }
                
                return {
                    title: rule.title,
                    description: rule.description,
                    badges: badges,
                    tags: rule.tags || []
                };
            })
        };
    }
    
    function displaySpecialRules(rules, filteredRules = null) {
        const rulesToShow = filteredRules || rules;
        
        if (rulesToShow.length === 0) {
            $('#rules-container').html('<div class="alert alert-info">No rules match the current filter criteria.</div>');
            return;
        }
        
        // Check if template is loaded
        if (!eaTemplating.templates['special-rules-list']) {
            $('#rules-container').html('<div class="alert alert-warning">Template loading... Please try again in a moment.</div>');
            return;
        }
        
        const templateData = prepareRulesForTemplate(rulesToShow, allRules.length);
        const html = eaTemplating.templates['special-rules-list'](templateData);
        $('#rules-container').html(html);
    }
    
    function setupDynamicFilters(rules) {
        // Collect all unique tags (excluding 'core' which is handled specially)
        var allTags = new Set();
        
        rules.forEach(function(rule) {
            if (rule.tags && Array.isArray(rule.tags)) {
                rule.tags.forEach(function(tag) {
                    if (tag !== 'core') {
                        allTags.add(tag);
                    }
                });
            }
        });
        
        // Sort tags alphabetically
        var sortedTags = Array.from(allTags).sort();
        
        // Generate dynamic filter buttons
        var tagFiltersContainer = $('#tag-filters');
        
        sortedTags.forEach(function(tag) {
            var buttonText = tag.charAt(0).toUpperCase() + tag.slice(1);
            var button = $('<button type="button" class="btn btn-outline-secondary" data-filter="' + tag + '">' + buttonText + '</button>');
            tagFiltersContainer.append(button);
        });
    }
    
    function setupFiltering(rules) {
        const excludeCheckbox = $('#excludeCore');
        
        function applyFilters() {
            const activeFilter = $('#tag-filters button.active').data('filter');
            const excludeCore = excludeCheckbox.is(':checked');
            
            let filteredRules = rules;
            
            // Apply core filter (special case)
            if (excludeCore) {
                filteredRules = filteredRules.filter(rule => {
                    // Check tags array for core tag
                    return !(rule.tags && Array.isArray(rule.tags) && rule.tags.includes('core'));
                });
            }
            
            // Apply tag filter
            if (activeFilter && activeFilter !== 'all') {
                filteredRules = filteredRules.filter(rule => {
                    // Check if rule has the selected tag
                    return rule.tags && Array.isArray(rule.tags) && rule.tags.includes(activeFilter);
                });
            }
            
            displaySpecialRules(allRules, filteredRules);
        }
        
        // Dynamic filter button handlers (using event delegation)
        $('#tag-filters').on('click', 'button[data-filter]', function() {
            $('#tag-filters button').removeClass('active');
            $(this).addClass('active');
            applyFilters();
        });
        
        // Checkbox handler
        excludeCheckbox.on('change', function() {
            applyFilters();
        });
        
        // Initial filter application
        applyFilters();
    }
});
</script>
